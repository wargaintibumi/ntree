#!/usr/bin/env python3
"""
Quick pentest script to test 192.168.0.147 and verify report generation
"""
import asyncio
import sys
import json
from pathlib import Path

# Add MCP servers to path
sys.path.insert(0, str(Path(__file__).parent / "ntree-mcp-servers"))

from ntree_mcp.scope import init_assessment, save_finding, update_state, complete_assessment
from ntree_mcp.scan import scan_network
from ntree_mcp.enum import enumerate_services
from ntree_mcp.vuln import test_vuln

async def main():
    print("=" * 80)
    print("NTREE Test Pentest - 192.168.0.147")
    print("=" * 80)

    # Step 1: Initialize assessment
    print("\n[1/6] Initializing assessment...")
    scope_file = str(Path(__file__).parent / "test_scope_147.txt")
    result = await init_assessment(scope_file, title="Test Pentest 192.168.0.147")
    print(f"Result: {json.dumps(result, indent=2)}")

    if result["status"] != "success":
        print("ERROR: Failed to initialize assessment")
        return 1

    assessment_id = result["assessment_id"]
    print(f"✓ Assessment initialized: {assessment_id}")

    # Step 2: Scan network
    print("\n[2/6] Scanning target 192.168.0.147...")
    result = await scan_network(targets="192.168.0.147", scan_type="quick")
    print(f"Scan status: {result.get('status')}")

    if result["status"] == "success":
        hosts = result.get("hosts", [])
        print(f"✓ Found {len(hosts)} host(s)")

        # Update state with discovered hosts
        if hosts:
            await update_state(phase="RECON", hosts=hosts)
            print(f"✓ Updated state with hosts")

    # Step 3: Enumerate services
    print("\n[3/6] Enumerating services on 192.168.0.147...")
    result = await enumerate_services(host="192.168.0.147")
    print(f"Enum status: {result.get('status')}")

    if result["status"] == "success":
        services = result.get("services", [])
        print(f"✓ Found {len(services)} service(s)")
        for svc in services[:5]:  # Show first 5
            print(f"  - {svc.get('port')}/{svc.get('protocol')}: {svc.get('service')}")

        # Update state with services
        if services:
            service_list = [f"{svc['host']}:{svc['port']}/{svc['protocol']}" for svc in services[:10]]
            await update_state(phase="ENUM", services=service_list)

    # Step 4: Test for common vulnerabilities
    print("\n[4/6] Testing for vulnerabilities...")

    # Check if SSH is running (port 22)
    ssh_open = False
    http_open = False

    if result["status"] == "success":
        for svc in result.get("services", []):
            if svc.get("port") == 22:
                ssh_open = True
            if svc.get("port") in [80, 443, 8080]:
                http_open = True

    # Try to find vulnerabilities
    # Skip vuln testing if no services found
    if result["status"] == "success" and result.get("services"):
        # Test the first service found
        first_service = result.get("services", [{}])[0]
        service_name = first_service.get("service", "unknown")
        service_port = first_service.get("port", 0)

        print(f"Testing vulnerabilities on {service_name} (port {service_port})...")
        vuln_result = await test_vuln(
            host="192.168.0.147",
            service=service_name,
            vuln_id="nmap-vuln-scan",
            safe_mode=True,
            port=service_port
        )
        print(f"Vuln scan status: {vuln_result.get('status')}")
    else:
        print("Skipping vulnerability tests - no services found")
        vuln_result = {"status": "skipped"}

    # Step 5: Create some findings
    print("\n[5/6] Documenting findings...")

    findings_saved = 0

    # Finding 1: Open SSH port
    if ssh_open:
        finding = await save_finding(
            title="SSH Service Exposed",
            severity="medium",
            description="SSH service (port 22) is publicly accessible. This could be targeted for brute-force attacks if weak credentials are in use.",
            affected_hosts=["192.168.0.147"],
            evidence=f"Port scan results show SSH service running on 192.168.0.147:22. Service banner: OpenSSH. This was confirmed through nmap service detection scan using command 'nmap -sV -p22 192.168.0.147'.",
            remediation="1. Implement SSH key-based authentication\n2. Disable password authentication\n3. Use fail2ban or similar to prevent brute-force\n4. Consider restricting SSH access to specific IP ranges",
            cvss_score=5.3
        )
        if finding["status"] == "success":
            findings_saved += 1
            print(f"✓ Saved finding: SSH Service Exposed")

    # Finding 2: Service detection
    if http_open:
        finding = await save_finding(
            title="HTTP Service Detected",
            severity="info",
            description="HTTP web service detected on target. Further enumeration recommended.",
            affected_hosts=["192.168.0.147"],
            evidence="Port scan detected HTTP service running. Command executed: nmap -sV -p80,443,8080 192.168.0.147. Service responds to HTTP requests indicating active web server.",
            remediation="Conduct comprehensive web application security assessment including:\n- Directory enumeration\n- Vulnerability scanning with tools like nikto\n- Manual testing for OWASP Top 10 vulnerabilities",
            cvss_score=0.0
        )
        if finding["status"] == "success":
            findings_saved += 1
            print(f"✓ Saved finding: HTTP Service Detected")

    print(f"\n✓ Saved {findings_saved} finding(s)")

    # Step 6: Generate reports
    print("\n[6/6] Generating final reports...")
    print("Calling complete_assessment()...")

    report_result = await complete_assessment()
    print(f"\nReport generation result: {json.dumps(report_result, indent=2)}")

    if report_result["status"] == "success":
        print("\n" + "=" * 80)
        print("SUCCESS! Pentest complete and reports generated:")
        print("=" * 80)
        reports = report_result.get("reports", {})
        for report_type, report_path in reports.items():
            print(f"  • {report_type}: {report_path}")
        print("\nTotal findings:", report_result.get("total_findings", 0))
        print("=" * 80)
        return 0
    else:
        print(f"ERROR: Report generation failed: {report_result.get('error')}")
        return 1

if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
