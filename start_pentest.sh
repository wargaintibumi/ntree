#!/bin/bash
#
# NTREE Automated Penetration Testing Launcher
# Usage: ./start_pentest.sh [--scope <file>] [--mode api|sdk|interactive]
#
# This script helps define target scope and launches automated pentesting
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Default values
# NTREE_HOME points to runtime directory for assessments/logs
# NTREE_DEV is the development directory (where this script is located)
NTREE_HOME="${NTREE_HOME:-$HOME/ntree}"
NTREE_DEV="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCOPE_FILE=""
ROE_FILE=""
MODE="sdk"
MAX_ITERATIONS=50
SKIP_CONFIRMATION=false
ASSESSMENT_ID=""
VERBOSE=false

# Prescan options (enabled by default)
ENABLE_PRESCAN=true
PRESCAN_PORTS="standard"
PRESCAN_RATE=1000
PRESCAN_OUTPUT=""

# Banner
print_banner() {
    echo -e "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════════════╗"
    echo "║                                                                   ║"
    echo "║   ███╗   ██╗████████╗██████╗ ███████╗███████╗    ██╗   ██╗██████╗ ║"
    echo "║   ████╗  ██║╚══██╔══╝██╔══██╗██╔════╝██╔════╝    ██║   ██║╚════██╗║"
    echo "║   ██╔██╗ ██║   ██║   ██████╔╝█████╗  █████╗      ██║   ██║ █████╔╝║"
    echo "║   ██║╚██╗██║   ██║   ██╔══██╗██╔══╝  ██╔══╝      ╚██╗ ██╔╝██╔═══╝ ║"
    echo "║   ██║ ╚████║   ██║   ██║  ██║███████╗███████╗     ╚████╔╝ ███████╗║"
    echo "║   ╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝╚══════╝╚══════╝      ╚═══╝  ╚══════╝║"
    echo "║                                                                   ║"
    echo "║         Neural Tactical Red-Team Exploitation Engine              ║"
    echo "║                  Automated Penetration Testing                    ║"
    echo "║                                                                   ║"
    echo "╚═══════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Print colored messages
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Usage help
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "NTREE Automated Penetration Testing Launcher"
    echo "Helps define target scope and launches automated security testing."
    echo ""
    echo "Options:"
    echo "  -s, --scope <file>      Use existing scope file"
    echo "  -r, --roe <file>        Use existing rules of assessment file"
    echo "  -a, --assessment-id <id>  Custom assessment ID (default: auto-generated from timestamp)"
    echo "  -m, --mode <mode>       Execution mode: api, sdk, or interactive (default: sdk)"
    echo "  -i, --iterations <n>    Max iterations for autonomous mode (default: 50)"
    echo "  -y, --yes               Skip confirmation prompts"
    echo "  -v, --verbose           Show UserMessage and AssistantMessage (prompts/responses)"
    echo "  --prescan               Run prescan to discover live hosts before pentest (default: enabled)"
    echo "  --no-prescan            Disable prescan (skip host discovery)"
    echo "  --prescan-ports <mode>  Port scan mode: quick, standard, full (default: standard)"
    echo "  --prescan-rate <rate>   Masscan packet rate (default: 1000)"
    echo "  -h, --help              Show this help message"
    echo ""
    echo "═══════════════════════════════════════════════════════════════════════"
    echo "                              EXAMPLES"
    echo "═══════════════════════════════════════════════════════════════════════"
    echo ""
    echo "BASIC USAGE:"
    echo "  $0"
    echo "      Interactive mode - guides you through scope definition step by step"
    echo ""
    echo "  $0 --scope ~/targets.txt"
    echo "      Use an existing scope file for testing"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "INTERNAL NETWORK PENTEST:"
    echo ""
    echo "  # Test entire internal subnet"
    echo "  $0 --scope internal_network.txt"
    echo "  # Where internal_network.txt contains:"
    echo "  #   192.168.1.0/24"
    echo "  #   192.168.2.0/24"
    echo "  #   EXCLUDE 192.168.1.1      # Gateway"
    echo "  #   EXCLUDE 192.168.1.254    # Critical server"
    echo ""
    echo "  # Test specific internal servers with rules of assessment"
    echo "  $0 --scope servers.txt --roe corporate_roe.txt"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "EXTERNAL ATTACK SURFACE ASSESSMENT:"
    echo ""
    echo "  # Test company's external-facing assets"
    echo "  $0 --scope external_scope.txt --mode api"
    echo "  # Where external_scope.txt contains:"
    echo "  #   example.com"
    echo "  #   *.example.com"
    echo "  #   203.0.113.0/28"
    echo ""
    echo "  # Web application focused test"
    echo "  $0 --scope webapp_targets.txt --iterations 100"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "ACTIVE DIRECTORY / WINDOWS ENVIRONMENT:"
    echo ""
    echo "  # Test Windows domain environment"
    echo "  $0 --scope ad_scope.txt --roe ad_rules.txt"
    echo "  # Where ad_scope.txt contains:"
    echo "  #   10.10.10.0/24           # Domain network"
    echo "  #   dc01.corp.local         # Domain controller"
    echo "  #   EXCLUDE 10.10.10.1      # Production DC"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "LAB / CTF ENVIRONMENT:"
    echo ""
    echo "  # Quick scan of lab machines"
    echo "  $0 --scope lab.txt --iterations 30 --yes"
    echo ""
    echo "  # HackTheBox / TryHackMe style single target"
    echo "  $0 --scope htb_target.txt --mode sdk --iterations 75"
    echo "  # Where htb_target.txt contains:"
    echo "  #   10.10.10.100"
    echo ""
    echo "  # Multiple CTF boxes"
    echo "  $0 --scope ctf_boxes.txt --yes"
    echo "  # Where ctf_boxes.txt contains:"
    echo "  #   10.10.10.100"
    echo "  #   10.10.10.101"
    echo "  #   10.10.10.102"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "INTERACTIVE MODE (Human-in-the-loop with Claude Code):"
    echo ""
    echo "  # Start interactive session for learning/training"
    echo "  $0 --mode interactive"
    echo ""
    echo "  # Interactive with predefined scope"
    echo "  $0 --scope targets.txt --mode interactive"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "SCHEDULED / AUTOMATED TESTING:"
    echo ""
    echo "  # Non-interactive for cron jobs (skips confirmation)"
    echo "  $0 --scope weekly_targets.txt --roe automated_roe.txt --yes"
    echo ""
    echo "  # Quick vulnerability scan with limited iterations"
    echo "  $0 --scope quick_scan.txt --iterations 20 --yes"
    echo ""
    echo "  # Comprehensive overnight scan"
    echo "  $0 --scope full_network.txt --iterations 200 --yes"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "DIFFERENT EXECUTION MODES:"
    echo ""
    echo "  # API Mode (default) - Direct Anthropic API, fully autonomous"
    echo "  # Requires: ANTHROPIC_API_KEY"
    echo "  $0 --scope targets.txt --mode api"
    echo ""
    echo "  # SDK Mode - Uses Claude Code SDK, better MCP integration"
    echo "  # Requires: claude auth login (no API key needed)"
    echo "  $0 --scope targets.txt --mode sdk"
    echo ""
    echo "  # Interactive Mode - Human controls Claude Code directly"
    echo "  # Requires: claude auth login (no API key needed)"
    echo "  $0 --scope targets.txt --mode interactive"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "SCOPE FILE FORMAT:"
    echo ""
    echo "  # Comments start with #"
    echo "  # IP addresses"
    echo "  192.168.1.100"
    echo "  10.0.0.50"
    echo ""
    echo "  # CIDR ranges"
    echo "  192.168.1.0/24"
    echo "  10.10.0.0/16"
    echo ""
    echo "  # Domain names"
    echo "  example.com"
    echo "  *.staging.example.com"
    echo ""
    echo "  # Exclusions (will not be tested)"
    echo "  EXCLUDE 192.168.1.1"
    echo "  EXCLUDE production.example.com"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "AUTHENTICATION REQUIREMENTS:"
    echo ""
    echo "  Mode          Authentication Method"
    echo "  ──────────────────────────────────────────────────────────"
    echo "  api           ANTHROPIC_API_KEY environment variable"
    echo "  sdk           Claude Code auth (run: claude auth login)"
    echo "  interactive   Claude Code auth (run: claude auth login)"
    echo ""
    echo "  # API mode: Set API key before running"
    echo "  export ANTHROPIC_API_KEY='sk-ant-...'"
    echo "  $0 --scope targets.txt --mode api"
    echo ""
    echo "  # SDK/Interactive mode: Authenticate with Claude Code first"
    echo "  claude auth login"
    echo "  $0 --scope targets.txt --mode sdk"
    echo ""
    echo "───────────────────────────────────────────────────────────────────────"
    echo "ENVIRONMENT VARIABLES:"
    echo ""
    echo "  ANTHROPIC_API_KEY     Required for --mode api only"
    echo "  NTREE_HOME            NTREE installation directory (default: ~/ntree)"
    echo ""
    echo "═══════════════════════════════════════════════════════════════════════"
    echo ""
    exit 0
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -s|--scope)
                SCOPE_FILE="$2"
                shift 2
                ;;
            -r|--roe)
                ROE_FILE="$2"
                shift 2
                ;;
            -a|--assessment-id)
                ASSESSMENT_ID="$2"
                shift 2
                ;;
            -m|--mode)
                MODE="$2"
                shift 2
                ;;
            -i|--iterations)
                MAX_ITERATIONS="$2"
                shift 2
                ;;
            -y|--yes)
                SKIP_CONFIRMATION=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --prescan)
                ENABLE_PRESCAN=true
                shift
                ;;
            --no-prescan)
                ENABLE_PRESCAN=false
                shift
                ;;
            --prescan-ports)
                PRESCAN_PORTS="$2"
                shift 2
                ;;
            --prescan-rate)
                PRESCAN_RATE="$2"
                shift 2
                ;;
            -h|--help)
                usage
                ;;
            *)
                error "Unknown option: $1"
                usage
                ;;
        esac
    done
}

# Check prerequisites
check_prerequisites() {
    info "Checking prerequisites..."

    local missing=false

    # Check Python
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version 2>&1 | cut -d' ' -f2)
        success "Python 3 found: $PYTHON_VERSION"
    else
        error "Python 3 not found. Please install Python 3.10+"
        missing=true
    fi

    # Check NTREE directories (development or installed)
    if [[ -d "$NTREE_DEV/ntree-mcp-servers" ]]; then
        success "NTREE MCP servers found (development: $NTREE_DEV)"
    elif [[ -d "$NTREE_HOME/ntree-mcp-servers" ]]; then
        success "NTREE MCP servers found (installed: $NTREE_HOME)"
    else
        error "NTREE MCP servers not found at $NTREE_DEV/ntree-mcp-servers or $NTREE_HOME/ntree-mcp-servers"
        missing=true
    fi

    if [[ -d "$NTREE_DEV/ntree-autonomous" ]]; then
        success "NTREE autonomous agents found (development: $NTREE_DEV)"
    elif [[ -d "$NTREE_HOME/ntree-autonomous" ]]; then
        success "NTREE autonomous agents found (installed: $NTREE_HOME)"
    else
        error "NTREE autonomous agents not found at $NTREE_DEV/ntree-autonomous or $NTREE_HOME/ntree-autonomous"
        missing=true
    fi

    # Check API key (only required for API mode)
    if [[ "$MODE" == "api" ]]; then
        if [[ -n "$ANTHROPIC_API_KEY" ]]; then
            success "ANTHROPIC_API_KEY is set"
        else
            warn "ANTHROPIC_API_KEY not set. Required for API mode."
            echo -n "Enter your Anthropic API key (or press Enter to skip): "
            read -r -s api_key  # -s for silent input (hide key)
            echo ""
            if [[ -n "$api_key" ]]; then
                export ANTHROPIC_API_KEY="$api_key"
                success "API key set for this session"
            else
                error "API key required for API mode"
                echo "  Tip: Use --mode sdk or --mode interactive (no API key needed)"
                missing=true
            fi
        fi
    elif [[ "$MODE" == "sdk" ]]; then
        # SDK mode uses Claude Code authentication and Python SDK
        if command -v claude &> /dev/null; then
            success "Claude Code CLI found (SDK mode uses Claude Code auth)"
        else
            warn "Claude Code CLI not found. SDK mode requires 'claude' command."
            warn "Install Claude Code or use --mode api with ANTHROPIC_API_KEY"
            missing=true
        fi

        # Check if claude-code-sdk is installed in sectools venv
        if [[ -f "$HOME/venvs/sectools/bin/python" ]]; then
            if "$HOME/venvs/sectools/bin/python" -c "import claude_code_sdk" 2>/dev/null; then
                success "claude-code-sdk Python package found"
            else
                error "claude-code-sdk not installed in ~/venvs/sectools"
                echo "  Run: source ~/venvs/sectools/bin/activate && pip install claude-code-sdk"
                missing=true
            fi
        else
            error "Sectools virtual environment not found at ~/venvs/sectools"
            echo "  Please run setup.sh to install NTREE dependencies"
            missing=true
        fi
    elif [[ "$MODE" == "interactive" ]]; then
        # Interactive mode uses Claude Code
        if command -v claude &> /dev/null; then
            success "Claude Code CLI found"
        else
            error "Claude Code CLI not found. Install 'claude' for interactive mode."
            missing=true
        fi
    fi

    # Check for nmap (essential tool)
    if command -v nmap &> /dev/null; then
        success "nmap found"
    else
        warn "nmap not found. Some scanning features will be limited."
    fi

    if [[ "$missing" == true ]]; then
        error "Missing prerequisites. Please fix the issues above and try again."
        exit 1
    fi

    echo ""
}

# Create scope file interactively
create_scope_interactive() {
    info "Starting interactive scope definition..."
    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}                    SCOPE DEFINITION                           ${NC}"
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Define the targets you are AUTHORIZED to test."
    echo "You can specify:"
    echo "  - IP addresses (e.g., 192.168.1.100)"
    echo "  - CIDR ranges (e.g., 192.168.1.0/24)"
    echo "  - Domains (e.g., example.com)"
    echo "  - Wildcard domains (e.g., *.example.com)"
    echo ""
    echo -e "${RED}WARNING: Only include targets you have WRITTEN AUTHORIZATION to test!${NC}"
    echo ""

    # Create timestamp for unique filename
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)

    # Ensure directory exists
    mkdir -p "$NTREE_HOME/assessments"

    # Assessment ID
    echo -n "Assessment ID (leave blank for auto-generated): "
    read -r user_assessment_id

    # Use user-provided ID or generate from timestamp
    if [[ -n "$user_assessment_id" ]]; then
        ASSESSMENT_ID="$user_assessment_id"
    else
        ASSESSMENT_ID="assess_${TIMESTAMP}"
    fi

    SCOPE_FILE="$NTREE_HOME/assessments/scope_${ASSESSMENT_ID}.txt"

    # Start building scope file
    echo "# NTREE Scope File" > "$SCOPE_FILE"
    echo "# Generated: $(date)" >> "$SCOPE_FILE"
    echo "# Assessment ID: $ASSESSMENT_ID" >> "$SCOPE_FILE"
    echo "" >> "$SCOPE_FILE"
    echo "# Included Targets" >> "$SCOPE_FILE"

    # Collect included targets
    echo ""
    echo -e "${GREEN}Enter targets to INCLUDE (one per line, empty line when done):${NC}"
    while true; do
        echo -n "  Include> "
        read -r target
        if [[ -z "$target" ]]; then
            break
        fi
        echo "$target" >> "$SCOPE_FILE"
        success "Added: $target"
    done

    # Collect excluded targets
    echo "" >> "$SCOPE_FILE"
    echo "# Excluded Targets" >> "$SCOPE_FILE"

    echo ""
    echo -e "${RED}Enter targets to EXCLUDE (one per line, empty line when done):${NC}"
    while true; do
        echo -n "  Exclude> "
        read -r target
        if [[ -z "$target" ]]; then
            break
        fi
        echo "EXCLUDE $target" >> "$SCOPE_FILE"
        warn "Excluded: $target"
    done

    echo ""
    success "Scope file created: $SCOPE_FILE"
    echo ""
    echo "Scope file contents:"
    echo -e "${CYAN}───────────────────────────────────────────${NC}"
    cat "$SCOPE_FILE"
    echo -e "${CYAN}───────────────────────────────────────────${NC}"
    echo ""
}

# Create rules of assessment
create_roe_interactive() {
    echo ""
    echo -n "Would you like to define Rules of Assessment? (y/N): "
    read -r create_roe

    if [[ "$create_roe" =~ ^[Yy]$ ]]; then
        ROE_FILE="$NTREE_HOME/assessments/roe_${ASSESSMENT_ID}.txt"

        echo ""
        echo -e "${YELLOW}Rules of Assessment Definition${NC}"
        echo ""

        echo "# NTREE Rules of Assessment" > "$ROE_FILE"
        echo "# Generated: $(date)" >> "$ROE_FILE"
        echo "" >> "$ROE_FILE"

        # Testing window
        echo -n "Testing window (e.g., '9AM-5PM EST' or 'anytime'): "
        read -r window
        echo "TESTING_WINDOW: ${window:-anytime}" >> "$ROE_FILE"

        # Credential testing
        echo -n "Allow credential testing? (y/N): "
        read -r cred_test
        if [[ "$cred_test" =~ ^[Yy]$ ]]; then
            echo "ALLOW_CREDENTIAL_TESTING: true" >> "$ROE_FILE"
        else
            echo "ALLOW_CREDENTIAL_TESTING: false" >> "$ROE_FILE"
        fi

        # Exploitation
        echo -n "Allow exploitation attempts? (y/N): "
        read -r exploit
        if [[ "$exploit" =~ ^[Yy]$ ]]; then
            echo "ALLOW_EXPLOITATION: true" >> "$ROE_FILE"
        else
            echo "ALLOW_EXPLOITATION: false" >> "$ROE_FILE"
        fi

        # Post-exploitation
        echo -n "Allow post-exploitation (credential extraction)? (y/N): "
        read -r post_exploit
        if [[ "$post_exploit" =~ ^[Yy]$ ]]; then
            echo "ALLOW_POST_EXPLOITATION: true" >> "$ROE_FILE"
        else
            echo "ALLOW_POST_EXPLOITATION: false" >> "$ROE_FILE"
        fi

        # Scan intensity
        echo -n "Scan intensity (stealth/normal/aggressive) [normal]: "
        read -r intensity
        echo "SCAN_INTENSITY: ${intensity:-normal}" >> "$ROE_FILE"

        # Emergency contact
        echo -n "Emergency contact (email/phone): "
        read -r contact
        if [[ -n "$contact" ]]; then
            echo "EMERGENCY_CONTACT: $contact" >> "$ROE_FILE"
        fi

        echo ""
        success "ROE file created: $ROE_FILE"
    fi
}

# Validate file path is within allowed directories
validate_file_path() {
    local file_path="$1"
    local file_type="$2"

    # Check file exists
    if [[ ! -f "$file_path" ]]; then
        error "$file_type not found: $file_path"
        exit 1
    fi

    # Get real path and check it's within allowed directories
    local real_path=$(realpath "$file_path")

    # Allow files in:
    # 1. NTREE_HOME directory
    # 2. User's home directory
    # 3. /tmp (for temporary files)
    if [[ ! "$real_path" =~ ^${NTREE_HOME}/.* ]] && \
       [[ ! "$real_path" =~ ^${HOME}/.* ]] && \
       [[ ! "$real_path" =~ ^/tmp/.* ]]; then
        error "$file_type must be in NTREE directory ($NTREE_HOME), home directory, or /tmp"
        error "Attempted path: $real_path"
        exit 1
    fi

    success "$file_type path validated: $real_path" >&2
    echo "$real_path"
}

# Validate scope file
validate_scope() {
    local scope="$1"

    if [[ ! -f "$scope" ]]; then
        error "Scope file not found: $scope"
        exit 1
    fi

    # Count valid targets
    local target_count=$(grep -v '^#' "$scope" | grep -v '^$' | grep -v '^EXCLUDE' | wc -l)

    if [[ $target_count -eq 0 ]]; then
        error "No targets defined in scope file"
        exit 1
    fi

    success "Scope file validated: $target_count targets defined"
}

# Run prescan if enabled
run_prescan() {
    if [[ "$ENABLE_PRESCAN" != true ]]; then
        return 0
    fi

    info "Running prescan to discover live hosts..."
    echo ""

    # Determine prescan script location
    local prescan_script=""
    if [[ -f "$NTREE_DEV/ntree-autonomous/prescan.py" ]]; then
        prescan_script="$NTREE_DEV/ntree-autonomous/prescan.py"
    elif [[ -f "$NTREE_HOME/ntree-autonomous/prescan.py" ]]; then
        prescan_script="$NTREE_HOME/ntree-autonomous/prescan.py"
    else
        error "Prescan script not found"
        return 1
    fi

    # Use sectools venv for prescan (has required dependencies)
    local prescan_python="python3"
    if [[ -f "$HOME/venvs/sectools/bin/python" ]]; then
        prescan_python="$HOME/venvs/sectools/bin/python"
    fi

    # Create prescan output directory
    PRESCAN_OUTPUT="$NTREE_HOME/prescans/prescan_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$PRESCAN_OUTPUT"

    # Build prescan command
    local prescan_cmd=("$prescan_python" "$prescan_script")
    prescan_cmd+=("--scope" "$SCOPE_FILE")
    prescan_cmd+=("--output" "$PRESCAN_OUTPUT")
    prescan_cmd+=("--ports" "$PRESCAN_PORTS")
    prescan_cmd+=("--rate" "$PRESCAN_RATE")

    if [[ "$VERBOSE" == true ]]; then
        prescan_cmd+=("--verbose")
    fi

    info "Executing prescan: ${prescan_cmd[*]}"
    echo ""

    # Run prescan
    if ! "${prescan_cmd[@]}"; then
        warn "Prescan completed with warnings or errors"
    fi

    # Check for live targets file
    local live_targets="$PRESCAN_OUTPUT/live_targets.txt"
    if [[ -f "$live_targets" ]]; then
        local host_count=$(grep -v '^#' "$live_targets" | grep -v '^$' | wc -l)
        success "Prescan found $host_count live hosts"

        # Use live targets for pentest if hosts were found
        if [[ $host_count -gt 0 ]]; then
            info "Using live targets file for pentest: $live_targets"
            ORIGINAL_SCOPE_FILE="$SCOPE_FILE"
            SCOPE_FILE="$live_targets"
        else
            warn "No live hosts found, using original scope file"
        fi
    else
        warn "Live targets file not generated, using original scope file"
    fi

    echo ""
}

# Confirmation prompt
confirm_execution() {
    if [[ "$SKIP_CONFIRMATION" == true ]]; then
        return 0
    fi

    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}                    EXECUTION SUMMARY                          ${NC}"
    echo -e "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "  Scope File:      $SCOPE_FILE"
    if [[ -n "$ROE_FILE" ]]; then
        echo "  ROE File:        $ROE_FILE"
    fi
    echo "  Execution Mode:  $MODE"
    if [[ "$MODE" != "interactive" ]]; then
        echo "  Max Iterations:  $MAX_ITERATIONS"
    fi
    if [[ "$ENABLE_PRESCAN" == true ]]; then
        echo "  Prescan:         enabled (ports: $PRESCAN_PORTS, rate: $PRESCAN_RATE)"
    fi
    echo ""
    echo -e "${RED}LEGAL DISCLAIMER:${NC}"
    echo "  By proceeding, you confirm that you have WRITTEN AUTHORIZATION"
    echo "  to perform security testing against the defined targets."
    echo "  Unauthorized access to computer systems is illegal."
    echo ""
    echo -n "Do you want to proceed with the penetration test? (yes/no): "
    read -r confirm

    if [[ "$confirm" != "yes" ]]; then
        warn "Aborted by user"
        exit 0
    fi
}

# Start the pentest
start_pentest() {
    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}                 STARTING PENETRATION TEST                     ${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo ""

    # Use appropriate venv python based on mode
    PYTHON="python3"

    if [[ "$MODE" == "api" ]] || [[ "$MODE" == "sdk" ]]; then
        # Autonomous modes need the sectools venv with claude-code-sdk
        if [[ -f "$HOME/venvs/sectools/bin/python" ]]; then
            PYTHON="$HOME/venvs/sectools/bin/python"
            info "Using sectools virtual environment (has claude-code-sdk)"
        else
            warn "Sectools venv not found, using system Python"
        fi
    else
        # Interactive mode can use MCP servers venv or system Python
        if [[ -f "$NTREE_HOME/ntree-mcp-servers/venv/bin/python" ]]; then
            PYTHON="$NTREE_HOME/ntree-mcp-servers/venv/bin/python"
            info "Using MCP servers virtual environment"
        fi
    fi

    case "$MODE" in
        api)
            info "Starting in Autonomous API mode..."
            cd "$NTREE_HOME"

            # Build command array (safe from injection)
            CMD=("$PYTHON" "ntree-autonomous/ntree_agent.py" "--scope" "$SCOPE_FILE")
            if [[ -n "$ROE_FILE" ]]; then
                CMD+=("--roe" "$ROE_FILE")
            fi
            if [[ -n "$ASSESSMENT_ID" ]]; then
                CMD+=("--assessment-id" "$ASSESSMENT_ID")
            fi
            CMD+=("--max-iterations" "$MAX_ITERATIONS")
            if [[ "$VERBOSE" == true ]]; then
                CMD+=("--verbose")
                info "Verbose mode enabled: will display prompts and responses"
            fi
            # Pass prescan results if available
            if [[ -n "$PRESCAN_OUTPUT" ]] && [[ -f "$PRESCAN_OUTPUT/prescan_summary.json" ]]; then
                CMD+=("--prescan-result" "$PRESCAN_OUTPUT/prescan_summary.json")
            fi

            info "Executing: $PYTHON ntree-autonomous/ntree_agent.py --scope $SCOPE_FILE ..."
            echo ""
            "${CMD[@]}"
            ;;

        sdk)
            info "Starting in Autonomous SDK mode..."
            # Use development directory if it has the SDK agent, otherwise fall back to installed
            if [[ -f "$NTREE_DEV/ntree-autonomous/ntree_agent_sdk.py" ]]; then
                cd "$NTREE_DEV"
                info "Using development SDK: $NTREE_DEV"
            else
                cd "$NTREE_HOME"
                info "Using installed SDK: $NTREE_HOME"
            fi

            # Build command array (safe from injection)
            CMD=("$PYTHON" "ntree-autonomous/ntree_agent_sdk.py" "--scope" "$SCOPE_FILE")
            if [[ -n "$ROE_FILE" ]]; then
                CMD+=("--roe" "$ROE_FILE")
            fi
            if [[ -n "$ASSESSMENT_ID" ]]; then
                CMD+=("--assessment-id" "$ASSESSMENT_ID")
            fi
            CMD+=("--max-iterations" "$MAX_ITERATIONS")
            if [[ "$VERBOSE" == true ]]; then
                CMD+=("--verbose")
                info "Verbose mode enabled: will display prompts and responses"
            fi
            # Pass prescan results if available
            if [[ -n "$PRESCAN_OUTPUT" ]] && [[ -f "$PRESCAN_OUTPUT/prescan_summary.json" ]]; then
                CMD+=("--prescan-result" "$PRESCAN_OUTPUT/prescan_summary.json")
            fi

            info "Executing: $PYTHON ntree-autonomous/ntree_agent_sdk.py --scope $SCOPE_FILE ..."
            echo ""
            "${CMD[@]}"
            ;;

        interactive)
            info "Starting in Interactive mode with Claude Code..."
            echo ""
            echo "Claude Code will open. Use this prompt to start:"
            echo ""
            echo -e "${CYAN}Start NTREE with scope: $SCOPE_FILE${NC}"
            echo ""
            echo "Press Enter to launch Claude Code..."
            read -r

            cd "$NTREE_HOME"
            claude
            ;;

        *)
            error "Unknown mode: $MODE"
            exit 1
            ;;
    esac
}

# Cleanup on exit
cleanup() {
    echo ""
    info "Penetration test session ended"
}

trap cleanup EXIT

# Main execution
main() {
    print_banner
    parse_args "$@"
    check_prerequisites

    # If no scope file provided, create one interactively
    if [[ -z "$SCOPE_FILE" ]]; then
        create_scope_interactive
        create_roe_interactive
    else
        # Validate and expand path (prevents path traversal)
        SCOPE_FILE=$(validate_file_path "$SCOPE_FILE" "Scope file")
        validate_scope "$SCOPE_FILE"

        if [[ -n "$ROE_FILE" ]]; then
            ROE_FILE=$(validate_file_path "$ROE_FILE" "ROE file")
        fi
    fi

    # Run prescan if enabled (before confirmation so user sees live targets)
    run_prescan

    confirm_execution
    start_pentest
}

main "$@"
